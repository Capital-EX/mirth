import base/nat
import base/list
import base/str
import base/path
import base/io
import base/io/unsafe

import mirth/build

export tools
  mirth : List(Str) -- Int
  mirth-build : List(Str) -- Int
end

export mirth/main
  main     : List(Str) -- Int
  buildCmd : List(Str) -- Int
  helpCmd  : List(Str) -- Int
end

mirth = main
mirth-build = buildCmd

main =
  cond(
    nil? -> "USAGE: mirth COMMAND" _prim_unsafe_trace drop 1,
    unsnoc swap cond(
      dup "build"  streq -> drop buildCmd,
      dup "help"   streq -> drop helpCmd,
      dup "--help" streq -> drop helpCmd,
      dup "-h"     streq -> drop helpCmd,
      "mirth: Unknown command " swap <> ". Use --help to list commands." <> _prim_unsafe_trace drop 1
    )
  )

# mirth build [PACKAGE]
buildCmd : List(Str) -- Int
buildCmd =
  cond(
    nil? -> drop "src" path buildPkg unsafe_runIO,
    len? n2 n>= -> drop "USAGE: mirth build [PKG]" _prim_unsafe_trace 1,
    unsnoc drop path buildPkg unsafe_runIO
  )


# mirth -h, mirth --help, mirth help
helpCmd : List(Str) -- Int
helpCmd = drop "USAGE: mirth COMMAND\n\nOPTIONS\n    --help      Display this table.\n\nCOMMANDS\n    build       Build Mirth package." _prim_unsafe_print 0

